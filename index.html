<!doctype html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=0.8">
<title>新発田市の地区別人口</title>
<script src="database_json_2016.js"></script>
<script src="database_json_2017.js"></script>
<script src="database_json_2018.js"></script>
<script src="database_json_2019.js"></script>
<script src="database_json_2020.js"></script>
<script src="database_json_2021.js"></script>
<script src="database_json_2022.js"></script>
<script src="database_json_2023.js"></script>
<script src="database_json_2024.js"></script>
<script>
    var data = [];
    var area = ['赤谷','五十公野','加治','加治川','川東','佐々木','紫雲寺','菅谷','豊浦','本庁','松浦','米倉'];
    var database_json = [];
    function make_json_database() {
        database_json = [];
        database_json.push(database_json_2016);
        database_json.push(database_json_2017);
        database_json.push(database_json_2018);
        database_json.push(database_json_2019);
        database_json.push(database_json_2020);
        database_json.push(database_json_2021);
        database_json.push(database_json_2022);
        database_json.push(database_json_2023);
        database_json.push(database_json_2024);
    }

    var database = [];
    function make_database() {
        database = [];
        make_json_database();
        var total = 0;
        for (var y = 0; y < database_json.length; y++) {
            database.push([]);
            for (var m = 0; m < database_json[y].length / 288; m++) {
                database[y].push([]);
                for (var k = 0; k < area.length; k++) {
                    database[y][m].push([]);
                }
                for (var d = 0 + m * 288; d < 288 + m * 288; d++) {
                    if (d >= 0 + m * 288 && d < 87 + m * 288) {
                        if (isNaN(Number(database_json[y][d]['合計'])) == false) {
                            total = total + Number(database_json[y][d]['合計']);
                        }
                        if (d == 86 + m * 288) {
                            database[y][m][9].push(total);
                            total = 0;
                        }
                    } else if (d >= 87 + m * 288 && d < 98 + m * 288) {
                        if (isNaN(Number(database_json[y][d]['合計'])) == false) {
                            total = total + Number(database_json[y][d]['合計']);
                        }
                        if (d == 97 + m * 288) {
                            database[y][m][1].push(total);
                            total = 0;
                        }
                    } else if (d >= 98 + m * 288 && d < 110 + m * 288) {
                        if (isNaN(Number(database_json[y][d]['合計'])) == false) {
                            total = total + Number(database_json[y][d]['合計']);
                        }
                        if (d == 109 + m * 288) {
                            database[y][m][10].push(total);
                            total = 0;
                        }
                    } else if (d >= 110 + m * 288 && d < 114 + m * 288) {
                        if (isNaN(Number(database_json[y][d]['合計'])) == false) {
                            total = total + Number(database_json[y][d]['合計']);
                        }
                        if (d == 113 + m * 288) {
                            database[y][m][11].push(total);
                            total = 0;
                        }
                    } else if (d >= 114 + m * 288 && d < 117 + m * 288) {
                        if (isNaN(Number(database_json[y][d]['合計'])) == false) {
                            total = total + Number(database_json[y][d]['合計']);
                        }
                        if (d == 116 + m * 288) {
                            database[y][m][0].push(total);
                            total = 0;
                        }
                    } else if (d >= 117 + m * 288 && d < 137 + m * 288) {
                        if (isNaN(Number(database_json[y][d]['合計'])) == false) {
                            total = total + Number(database_json[y][d]['合計']);
                        }
                        if (d == 136 + m * 288) {
                            database[y][m][4].push(total);
                            total = 0;
                        }
                    } else if (d >= 137 + m * 288 && d < 160 + m * 288) {
                        if (isNaN(Number(database_json[y][d]['合計'])) == false) {
                            total = total + Number(database_json[y][d]['合計']);
                        }
                        if (d == 159 + m * 288) {
                            database[y][m][7].push(total);
                            total = 0;
                        }
                    } else if (d >= 160 + m * 288 && d < 172 + m * 288) {
                        if (isNaN(Number(database_json[y][d]['合計'])) == false) {
                            total = total + Number(database_json[y][d]['合計']);
                        }
                        if (d == 171 + m * 288) {
                            database[y][m][2].push(total);
                            total = 0;
                        }
                    } else if (d >= 172 + m * 288 && d < 188 + m * 288) {
                        if (isNaN(Number(database_json[y][d]['合計'])) == false) {
                            total = total + Number(database_json[y][d]['合計']);
                        }
                        if (d == 187 + m * 288) {
                            database[y][m][5].push(total);
                            total = 0;
                        }
                    } else if (d >= 188 + m * 288 && d < 217 + m * 288) {
                        if (isNaN(Number(database_json[y][d]['合計'])) == false) {
                            total = total + Number(database_json[y][d]['合計']);
                        }
                        if (d == 216 + m * 288) {
                            database[y][m][8].push(total);
                            total = 0;
                        }
                    } else if (d >= 217 + m * 288 && d < 244 + m * 288) {
                        if (isNaN(Number(database_json[y][d]['合計'])) == false) {
                            total = total + Number(database_json[y][d]['合計']);
                        }
                        if (d == 243 + m * 288) {
                            database[y][m][6].push(total);
                            total = 0;
                        }
                    } else if (d >= 244 + m * 288 && d < 288 + m * 288) {
                        if (isNaN(Number(database_json[y][d]['合計'])) == false) {
                            total = total + Number(database_json[y][d]['合計']);
                        }
                        if (d == 287 + m * 288) {
                            database[y][m][3].push(total);
                            total = 0;
                        }
                    }
                }
            }
        }
    }

    var year = 0;
    var month = 0;
    function time_set() {
        make_json_database();
        for (var i = 0; i < database_json.length; i++) {
            for (var j = 0; j < database_json[i].length / 288; j++) {
                if (database_json[i][j]['コード'].length != 0) {
                    year = i + 2016;
                    month = j + 1;
                } else {
                    break;
                }
            }
        }
    }

    function dropdown(onload, selected_year, selected_month) {
        if (onload == 1) {
            time_set();
            make_database();
        }
        var select_box_year = document.getElementById('year');
        var select_box_month = document.getElementById('month');
        var select_box_standard_year = document.getElementById('standard_year');
        var select_box_standard_month = document.getElementById('standard_month');
        var selected_standard_year = document.getElementById('standard_year').value;
        var selected_standard_month = document.getElementById('standard_month').value;
        if (onload != 1) {
            for (var i = select_box_year.length - 1; i >= 0; i--) {
                select_box_year.remove(i);
                select_box_standard_year.remove(i);
            }
            for (var i = select_box_month.length - 1; i >= 0; i--) {
                select_box_month.remove(i);
            }
            for (var i = select_box_standard_month.length - 1; i >= 0; i--) {
                select_box_standard_month.remove(i);
            }
        }
        for (var i = 2016; i < year + 1; i++) {
            var select = document.getElementById('year');
            var option = document.createElement('option');
            option.text = i;
            option.value = i;
            select.appendChild(option);
            if (option.value == year && onload == 1) {
                option.setAttribute("selected", true);
            } else if (option.value == selected_year && onload == 0) {
                option.setAttribute("selected", true);
            } else if (option.value == selected_year + 2016 && onload == 2) {
                option.setAttribute("selected", true);
            }
        }
        for (var i = 2016; i < year + 1; i++) {
            var select = document.getElementById('standard_year');
            var option = document.createElement('option');
            option.text = i;
            option.value = i;
            select.appendChild(option);
            if (option.value == 2016 && onload == 1) {
                option.setAttribute("selected", true);
            } else if (option.value == selected_standard_year && onload == 0 || option.value == selected_standard_year && onload == 2) {
                option.setAttribute("selected", true);
            }
        }
        for (var i = 1; i < 13; i++) {
            var select = document.getElementById('month');
            var option = document.createElement('option');
            option.text = i;
            option.value = i;
            select.appendChild(option);
            if (onload == 1) {
                if (option.value == month) {
                    option.setAttribute("selected", true);
                    break;
                }
            } else if (onload == 0) {
                if (year == selected_year && month < selected_month) {
                    if (option.value == month) {
                        option.setAttribute("selected", true);
                        break;
                    }
                } else {
                    if (option.value == selected_month) {
                        option.setAttribute("selected", true);
                    }
                    if (year == selected_year && option.value == month) {
                        break;
                    }
                }
            } else if (onload == 2) {
                if (option.value == selected_month + 1) {
                    option.setAttribute("selected", true);
                    if (year == selected_year + 2016) {
                        break;
                    }
                }
            }
        }
        for (var i = 1; i < 13; i++) {
            var select = document.getElementById('standard_month');
            var option = document.createElement('option');
            option.text = i;
            option.value = i;
            select.appendChild(option);
            if (onload == 1) {
                if (option.value == 1) {
                    option.setAttribute("selected", true);
                    break;
                }
            } else if (onload == 0 || onload == 2) {
                if (year == selected_standard_year && month < selected_standard_month) {
                    if (option.value == month) {
                        option.setAttribute("selected", true);
                        break;
                    }
                } else {
                    if (option.value == selected_standard_month) {
                        option.setAttribute("selected", true);
                    }
                    if (year == selected_standard_year && option.value == month) {
                        break;
                    }
                }
            }
        }
        if (onload == 1) {
            setting(0);
        }
    }
    var year_gap = 0;
    var month_gap = 0;
    var over_frame_chart = 0;
    var before_radian_start = [];
    var before_radian_end = [];
    var frame = 0;
    var chart_version = 0;
    var on_off = 'on';
    var setinterval;
    function setting(animation_button) {
        year_gap = 0;
        month_gap = 0;
        frame = 0;
        var selected_year = document.getElementById('year').value;
        var selected_month = document.getElementById('month').value;
        var div_pyramid = document.getElementById('population_pyramid');
        var div_chart = document.getElementById('pie_chart');
        var standard_date = document.getElementById('standard_date');
        dropdown(0, selected_year, selected_month);
        if (year == selected_year && month < selected_month) {
            selected_year = year;
            selected_month = month;
        }
        if (animation_button == 3) {
            chart_version = 0;
        }

        if (animation_button == 1) {
            if (chart_version == 0) {
                animation(0);
            } else if (chart_version == 1) {
                animation(1);
            }
        } else if (animation_button == 2 || chart_version == 1) {
            if (on_off == 'off') {
                clearInterval(setinterval);
            }
            over_frame_chart = 0;
            before_radian_start = [];
            before_radian_end = [];

            div_pyramid.style.display = 'none';
            div_chart.style.display = 'block';
            standard_date.style.display = 'none';
            setinterval = setInterval(chart, 1, selected_year - 2016, selected_month - 1, 0);
        } else if (animation_button == 0 || animation_button == 3) {
            if (on_off == 'off') {
                clearInterval(setinterval);
            }
            chart_version = 0;
            div_pyramid.style.display = 'block';
            div_chart.style.display = 'none';
            standard_date.style.display = 'inline';
            setinterval = setInterval(glaph, 1, selected_year - 2016, selected_month - 1, 0);
        }
        
    }

    function glaph(selected_year, selected_month, animation_mode) {
        make_database();
        var standard_year = document.getElementById('standard_year').value;
        var standard_month = document.getElementById('standard_month').value;
        var standard_data = database[standard_year - 2016][standard_month - 1];
        data = database[selected_year + year_gap][selected_month + month_gap];
        if (animation_mode == 1) {
            dropdown(2, selected_year + year_gap, selected_month + month_gap);
            if (year == selected_year + 2016 + year_gap && month == selected_month + 1 + month_gap) {
                clearInterval(setinterval);
                glaph(selected_year, selected_month, 0);
            } else {
                if (selected_month + 1 + month_gap <= 11) {
                    month_gap++;
                } else if (selected_month + 1 + month_gap >= 12) {
                    year_gap++;
                    month_gap = 0 - selected_month;
                }
            }
        } else if (animation_mode == 0) {
            on_off = 'on';
        }

        var over_frame = 0;
        frame = frame + 5;
        var canvas = document.getElementById('canvas');
        var pen = canvas.getContext("2d");
        pen.clearRect(0, 0, canvas.width, canvas.height);
        pen.beginPath();
        pen.lineWidth = 25;
        for (var i = 0; i < area.length; i++) {
            pen.beginPath();
            pen.strokeStyle = "rgb(0,200,0)";
            pen.moveTo(70, 30 + 30 * i);
            if (animation_mode == 0) {
                if (frame > data[i] * 370 / standard_data[i]) {
                    over_frame++;
                    pen.lineTo(70 + data[i] * 370 / standard_data[i], 30 + 30 * i);
                } else {
                    pen.lineTo(70 + frame, 30 + 30 * i);
                }
            } else {
                pen.lineTo(70 + data[i] * 370 / standard_data[i], 30 + 30 * i);
            }
            pen.stroke();
        }

        pen.beginPath();
        pen.fillStyle = "rgb(0,0,0)";
        pen.textAlign = 'center';
        pen.font = "15px sans-serif";
        for (var i = 0; i < 16; i++){
            pen.fillText(i * 10, 70 + i * 37, 395);
        }
        for (var i = 0; i < area.length; i++) {
            pen.fillText(area[i], 35, 35 + 30 * i);
        }
        pen.fillText('(地区)', 35, 390);
        pen.fillText('(%)', 660, 395);

        pen.beginPath();
        pen.strokeStyle = "rgb(0,0,0)";
        pen.lineWidth = 1;
        pen.moveTo(70, 380);
        pen.lineTo(canvas.width - 60, 380);
        pen.lineTo(canvas.width - 60, 10);
        pen.lineTo(70, 10);
        pen.lineTo(70,380);
        pen.stroke();

        pen.beginPath();
        pen.strokeStyle = "rgba(0,0,0,0.5)";
        pen.lineWidth = 1;
        for (var i = 0; i < 16; i++){
            pen.moveTo(70 + i * 37, 10);
            pen.lineTo(70 + i * 37, 380);
        }
        pen.stroke();
        if (animation_mode == 0) {
            if (over_frame >= area.length) {
                clearInterval(setinterval);
            }
        }
    }

    function chart(selected_year, selected_month, animation_mode) {
        make_database();
        data = database[selected_year + year_gap][selected_month + month_gap];
        if (animation_mode == 1) {
            dropdown(2, selected_year + year_gap, selected_month + month_gap);
            if (year == selected_year + 2016 + year_gap && month == selected_month + 1 + month_gap) {
                clearInterval(setinterval);
                chart(selected_year, selected_month, 0);
            } else {
                if (selected_month + 1 + month_gap <= 11) {
                    month_gap++;
                } else if (selected_month + 1 + month_gap >= 12) {
                    year_gap++;
                    month_gap = 0 - selected_month;
                }
            }
        } else if (animation_mode == 0) {
            on_off = 'on';
        }
        frame = frame + 5;
        var canvas = document.getElementById('canvas');
        var pen = canvas.getContext("2d");
        pen.clearRect(0, 0, canvas.width, canvas.height);
        pen.beginPath();
        // arc(x軸,y軸,半径,始まりの角度(ラジアン角),終わりの角度(ラジアン角),円ならtrue弧ならfalse) Math.PI == π
        pen.arc(canvas.width / 2, canvas.height / 2 - 15, 120, 0, Math.PI * 2, true);
        pen.stroke();

        var all_population = 0;
        for (var i = 0; i < data.length; i++) {
            all_population = all_population + Number(data[i]);
        }
        var percentage_list = [];
        var percentage_list_total = [0];
        for (var i = 0; i < data.length; i++) {
            percentage_list.push(Math.round(Number(data[i]) * 10000 / all_population) / 100);
            percentage_list_total.push(percentage_list_total[i] + percentage_list[i]);
        }
        var percentage = 0;
        if (frame >= percentage_list[over_frame_chart] + percentage_list_total[over_frame_chart]) {
            percentage = percentage_list[over_frame_chart] * 3.6;
        } else {
            percentage = (frame - percentage_list_total[over_frame_chart]) * 3.6;
        }

        var fillstyle_list = ["rgb(200,0,0)", "rgb(0,200,0)", "rgb(0,0,200)", "rgb(200,0,200)", "rgb(0,200,200)", "rgb(200,200,0)", "rgb(30,150,50)", "rgb(150,100,100)", "rgb(100,100,150)", "rgb(150,150,150)", "rgb(50,100,100)", "rgb(0,0,0)"];
        if (animation_mode == 0) {
            pen.beginPath();
            pen.fillStyle = fillstyle_list[over_frame_chart];
            var radianStart = (percentage_list_total[over_frame_chart] * 3.6 - 90) * Math.PI / 180;
            var radianEnd = radianStart + percentage * Math.PI / 180;
            if (frame >= percentage_list[over_frame_chart] + percentage_list_total[over_frame_chart]) {
                before_radian_start.push(radianStart);
                before_radian_end.push(radianEnd);
                over_frame_chart++;
            }
            pen.beginPath();
            pen.moveTo(canvas.width / 2, canvas.height / 2 - 15);
            pen.arc(canvas.width / 2, canvas.height / 2 - 15, 120, radianStart, radianEnd, false);
            pen.closePath();
            pen.fill();

            for (var i = 0; i < before_radian_start.length; i++) {
                pen.beginPath();
                pen.fillStyle = fillstyle_list[i];
                pen.beginPath();
                pen.moveTo(canvas.width / 2, canvas.height / 2 - 15);
                pen.arc(canvas.width / 2, canvas.height / 2 - 15, 120, before_radian_start[i], before_radian_end[i], false);
                pen.closePath();
                pen.fill();
            }
        } else {
            for (var i = 0; i < data.length; i++) {
                pen.beginPath();
                pen.fillStyle = fillstyle_list[i];
                pen.moveTo(canvas.width / 2, canvas.height / 2 - 15);
                var radian_mode = (percentage_list_total[i] * 3.6 - 90) * Math.PI / 180;
                pen.arc(canvas.width / 2, canvas.height / 2 - 15, 120, radian_mode, radian_mode + percentage_list[i] * 3.6 * Math.PI / 180, false);
                pen.closePath();
                pen.fill();
            }
        }
        pen.beginPath();
        pen.textAlign = 'center';
        pen.font = "25px sans-serif";
        pen.fillStyle = "rgb(0,0,0)";
        pen.fillText('年齢別人口構成比', canvas.width / 2, 50);
        pen.font = "15px sans-serif";
        for (var i = 0; i < percentage_list.length / 2; i++) {
            pen.fillStyle = fillstyle_list[i];
            pen.fillText(area[i] + Math.round(percentage_list[i] * 10) / 10 + '%', i * 100 + 105, 365);
        }
        for (var i = percentage_list.length / 2; i < percentage_list.length; i++) {
            pen.fillStyle = fillstyle_list[i];
            pen.fillText(area[i] + Math.round(percentage_list[i] * 10) / 10 + '%', (i - percentage_list.length / 2) * 100 + 105, 385);
        }

        chart_version = 1;
        if (animation_mode == 0) {
            if (over_frame_chart >= data.length) {
                clearInterval(setinterval);
            }
        }
    }

    function animation(chart_mode) {
        if (on_off == 'on') {
            on_off = 'off';
            clearInterval(setinterval);
            if (chart_mode == 0) {
                setinterval = setInterval(glaph, 100, 0, 0, 1);
            } else if (chart_mode == 1) {
                setinterval = setInterval(chart, 100, 0, 0, 1);
            }
        } else {
            year_gap = 0;
            month_gap = 0;
            on_off = 'on';
            clearInterval(setinterval);
        }
    }
</script>
<style>
body {
    font-family: sans-serif;
    margin: 0px;
}
h1 {
    background-color: #39a73b;
    color: #ffffff;
    font-size: 30px;
    margin: 0px;
    text-align: center;
}
p {
    text-align: center;
    font-size: 25px;
    margin: 10px auto;
}
canvas {
    display: block;
    margin: auto;
}
select {
    font-size: 25px;
    margin: 0px auto;
}
button {
    display: block;
    font-size: 25px;
    margin: 15px auto;
    margin-bottom: 25px;
}
div {
    display: none;
}
a {
    display: block;
    text-align: center;
}
.url {
    font-size: 15px;
}
</style>
</head>
<body onload="dropdown(1, 0, 0)">
<h1>新発田市の地区別人口</h1>
<canvas id="canvas" width="700" height="400"></canvas>
<a>
    <p id="standard_date">
        基準<select id="standard_year" onchange="setting(0)"></select>年
        <select id="standard_month" onchange="setting(0)"></select>月
    </p>
</a>
<p>
    <select id="year" onchange="setting(0)"></select>年
    <select id="month" onchange="setting(0)"></select>月
</p>
<div id="population_pyramid">
    <button onclick="setting(1)">人口の推移を<br>アニメーションで見る</button>
    <button onclick="setting(2)">人口構成比を<br>円グラフで見る</button>
</div>
<div id="pie_chart">
    <button onclick="setting(1)">人口構成比を<br>アニメーションで見る</button>
    <button onclick="setting(3)">棒グラフに戻る</button>
</div>
<p class="url"><a href="https://www.city.shibata.lg.jp/machidukuri/opendata/1024525.html">「町丁目字別人口、世帯数」（新発田市）</a>を加工して作成</p>
</body>
</html>